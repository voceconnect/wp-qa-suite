#!/bin/bash

#######################################
# setup test environment to run PHP
# unit tests with required wordpress
# testing libraries and configs
#######################################

set -euo pipefail
IFS=$'\n\t'

##
# CONSTANTS
##
readonly WP_TESTS_DIR="/tmp/wordpress-tests-lib"
readonly WP_CORE_DIR="/tmp/wordpress"
readonly PHPCS_DIR="/tmp/phpcs"
readonly WPCS_DIR="/tmp/wpcs"

#######################################
# validates and sets constants based
# on provided arguments
# Globals:
#   WP_ARCHIVE
#   DB_USER
#   DB_PASS
#   DB_NAME
#   DB_HOST
# Arguments:
#   $1 - wp_version
#   $2 - DB_USER
#   $3 - DB_PASS
#   $4 - DB_NAME
#   $5 - DB_HOST
# Returns:
#   Nothing
#######################################
function check_arguments() {
  local wp_version=${1:-}
  if [[ -z "${wp_version}" ]]; then
    echo "usage: $0 <wp_version> [DB_USER=travis] [DB_PASS=] [DB_NAME=wp_test] [DB_HOST=localhost]"
    exit 1
  else
    if [[ "${wp_version}" == "latest" ]]; then
      readonly WP_ARCHIVE="latest"
    else
      readonly WP_ARCHIVE="wordpress-${wp_version}"
    fi
  fi

  readonly DB_USER="${2:-travis}"
  readonly DB_PASS="${3:-}"
  readonly DB_NAME="${4:-wp_test}"
  readonly DB_HOST="${5:-localhost}"
}

#######################################
# retrieves latest or specified version
# of wordpress into WP_CORE_DIR
# Globals:
#   WP_CORE_DIR
#   WP_ARCHIVE
# Arguments:
#   None
# Returns:
#   Nothing
#######################################
function install_wordpress() {
  mkdir -p "${WP_CORE_DIR}"

  wget -nv -O "/tmp/wordpress.tar.gz" \
    "http://wordpress.org/${WP_ARCHIVE}.tar.gz"
  tar --strip-components=1 -zxmf "/tmp/wordpress.tar.gz" -C "${WP_CORE_DIR}"
}

#######################################
# setup of wordpress unit test
# includes and configuration
# Globals:
#   WP_TESTS_DIR
#   WP_CORE_DIR
#   DB_NAME
#   DB_USER
#   DB_PASS
#   DB_HOST
# Arguments:
#   None
# Returns:
#   Nothing
#######################################
function install_test_suite() {
  if [[ $(uname -s) == 'Darwin' ]]; then
    local ioption='-i ""'
  else
    local ioption='-i'
  fi

  mkdir -p "${WP_TESTS_DIR}"
  cd "${WP_TESTS_DIR}"
  svn co --quiet http://develop.svn.wordpress.org/trunk/tests/phpunit/includes/

  wget -nv -O wp-tests-config.php \
    http://develop.svn.wordpress.org/trunk/wp-tests-config-sample.php
  sed $ioption "s:dirname( __FILE__ ) . '/src/':'${WP_CORE_DIR}/':" \
    wp-tests-config.php
  sed $ioption "s/youremptytestdbnamehere/${DB_NAME}/" wp-tests-config.php
  sed $ioption "s/yourusernamehere/${DB_USER}/" wp-tests-config.php
  sed $ioption "s/yourpasswordhere/${DB_PASS}/" wp-tests-config.php
  sed $ioption "s|localhost|${DB_HOST}|" wp-tests-config.php
}

#######################################
# download and extract WP coding
# standards, add to phpcs installed paths
# Globals:
#   PHPCS_DIR
#   WPCS_DIR
# Arguments:
#   None
# Returns:
#   Nothing
#######################################
function install_wordpress_coding_standards() {
  mkdir -p "${WPCS_DIR}"

  wget -nv -O "/tmp/wpcs.tar.gz" \
    "https://github.com/WordPress-Coding-Standards/WordPress-Coding-Standards/archive/master.tar.gz"
  tar --strip-components=1 -zxmf "/tmp/wpcs.tar.gz" -C "${WPCS_DIR}"

  "vendor/bin/phpcs" --config-set installed_paths "${WPCS_DIR}"
}

#######################################
# creates DB_NAME database for tests
# Globals:
#   DB_NAME
#   DB_USER
#   DB_PASS
#   DB_HOST
# Arguments:
#   None
# Returns:
#   Nothing
#######################################
function setup_database() {
  mysql -e "DROP DATABASE IF EXISTS ${DB_NAME};" \
    --user="${DB_USER}" \
    --pass="${DB_PASS}" \
    --host="${DB_HOST}"
  mysql -e "CREATE DATABASE IF NOT EXISTS ${DB_NAME};" \
    --user="${DB_USER}" \
    --pass="${DB_PASS}" \
    --host="${DB_HOST}"
}

function main() {
  check_arguments "$@"

  install_wordpress
  install_test_suite
  install_wordpress_coding_standards
  setup_database
}

main "$@"
